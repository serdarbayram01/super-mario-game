# 502 Bad Gateway HatasÄ± Ã‡Ã¶zÃ¼mÃ¼

## ğŸ”´ Sorun

ALB'den gelen isteklerde "502 Bad Gateway" hatasÄ± alÄ±nÄ±yor.

## ğŸ” Tespit Edilen Sorunlar

1. **Target Type Sorunu**: ALB target group NodePort kullanÄ±yor, pod IP'lerine direkt eriÅŸemiyor
2. **Health Check BaÅŸarÄ±sÄ±z**: Target health check "unhealthy" durumunda
3. **Target Port**: 31961 (NodePort) kullanÄ±lÄ±yor, pod'lar bu portta eriÅŸilemiyor

## âœ… Ã‡Ã¶zÃ¼m

### 1. Target Type'Ä± IP Mode'a Ã‡evirme

Ingress'e `alb.ingress.kubernetes.io/target-type: "ip"` annotation'Ä± eklendi. Bu sayede ALB pod IP'lerine direkt eriÅŸebilir.

### 2. Health Check AyarlarÄ±

AÅŸaÄŸÄ±daki annotation'lar eklendi:

```yaml
alb.ingress.kubernetes.io/target-type: "ip"
alb.ingress.kubernetes.io/healthcheck-path: "/"
alb.ingress.kubernetes.io/healthcheck-protocol: "HTTP"
alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
alb.ingress.kubernetes.io/healthy-threshold-count: "2"
alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
alb.ingress.kubernetes.io/success-codes: "200"
```

## ğŸš€ Uygulama

```bash
# Ingress'i gÃ¼ncelle
kubectl apply -f ingress.yaml

# Ingress durumunu kontrol et
kubectl get ingress supermario-app-ingress

# BirkaÃ§ dakika bekle (ALB target group gÃ¼ncellenmesi iÃ§in)
sleep 60

# Target health durumunu kontrol et
aws elbv2 describe-target-health \
  --region eu-west-1 \
  --target-group-arn <TARGET_GROUP_ARN> \
  --query "TargetHealthDescriptions[*].{Target:Target.Id,Health:TargetHealth.State}" \
  --output table
```

## ğŸ“ AÃ§Ä±klama

### Target Type: IP vs Instance

- **Instance Mode (NodePort)**: ALB node IP'lerine ve NodePort'a eriÅŸir
  - Sorun: Pod'lar node'da farklÄ± portlarda Ã§alÄ±ÅŸabilir
  - Health check node'a gider, pod'a deÄŸil

- **IP Mode**: ALB pod IP'lerine direkt eriÅŸir
  - Avantaj: Pod'lara direkt eriÅŸim, daha gÃ¼venilir
  - Gereksinim: VPC CNI plugin (EKS'te varsayÄ±lan olarak kurulu)

### Health Check AyarlarÄ±

- **Path**: `/` (root path)
- **Protocol**: HTTP
- **Interval**: 30 saniye
- **Timeout**: 5 saniye
- **Healthy Threshold**: 2 baÅŸarÄ±lÄ± check
- **Unhealthy Threshold**: 3 baÅŸarÄ±sÄ±z check
- **Success Codes**: 200 (HTTP 200 OK)

## âœ… DoÄŸrulama

1. **Pod'larÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et**:
   ```bash
   kubectl get pods -l app=supermario
   ```

2. **Service endpoints'i kontrol et**:
   ```bash
   kubectl get endpoints supermario-service
   ```

3. **Target health durumunu kontrol et**:
   ```bash
   # ALB ARN'Ä± al
   ALB_ARN=$(aws elbv2 describe-load-balancers --region eu-west-1 \
     --query "LoadBalancers[?contains(DNSName, 'k8s-default-supermar')].LoadBalancerArn" \
     --output text)
   
   # Target group ARN'Ä± al
   TG_ARN=$(aws elbv2 describe-target-groups --region eu-west-1 \
     --load-balancer-arn $ALB_ARN \
     --query "TargetGroups[0].TargetGroupArn" \
     --output text)
   
   # Health durumunu kontrol et
   aws elbv2 describe-target-health --region eu-west-1 \
     --target-group-arn $TG_ARN
   ```

4. **Uygulamaya eriÅŸimi test et**:
   ```bash
   curl -I https://supermario.sbaylab.com
   ```

## ğŸ”§ Ek Notlar

- Target type deÄŸiÅŸikliÄŸi sonrasÄ± ALB target group yeniden oluÅŸturulur
- Eski target group birkaÃ§ dakika iÃ§inde silinir
- Pod IP'leri otomatik olarak target group'a eklenir
- Health check'ler birkaÃ§ dakika iÃ§inde "healthy" durumuna geÃ§er

